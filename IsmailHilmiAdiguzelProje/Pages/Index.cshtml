@page
@model IndexModel
@using System.Text.Json
@using IsmailHilmiAdiguzelProje.Models
@{
    ViewData["SubPageClass"] = "sub_page";
    List<String> images = new();
}

<!-- service section -->

<section class="service_section layout_padding">
    <div class="service_container">
        <div class="container ">
            <div class="heading_container heading_center">
                <h2>
                    @{
                        if (LoginModel.UserNameAndSurname != null)
                        {
                            <div>Welcome <span> @LoginModel.UserNameAndSurname</span></div>
                        }
                        else
                        {
                            <div>Our <span> Services</span></div>
                        }
                    }
                    
                </h2>
                <p>
                    There are many variations of passages of Lorem Ipsum available, but the majority have suffered alteration
                </p>
            </div>
            <div class="row">
                @{
                    using (var httpClient = new HttpClient())
                    {
                        using (var request = new HttpRequestMessage(new HttpMethod("GET"), "https://reklamaction.api.hasoffers.com/Apiv3/json?api_key=16cae276c0765bbe7e451fde1d1cd9bf69c1e8b05d37b1bc8ec25f68868d52de&Target=Affiliate_OfferFile&Method=findAll&limit=15"))
                        {
                            var httpResponseMessage = await httpClient.SendAsync(request);
                            var getResult = await httpResponseMessage.Content.ReadAsStringAsync();
                            var deserializedResponse = JsonSerializer.Deserialize<ImageDataObject>(getResult);
                            List<Dictionary<string, OfferImage>> elements = deserializedResponse.Response.Data.OfferImage.Values.ToList();
                            for (int i = 0; i < elements.Count; i++)
                            {
                                images.Add(elements[i]["OfferFile"].Url);
                            }
                        }
                    }
                }
                @{
                    using (var httpClient = new HttpClient())
                    {
                        using (var request = new HttpRequestMessage(new HttpMethod("GET"), "https://reklamaction.api.hasoffers.com/Apiv3/json?api_key=16cae276c0765bbe7e451fde1d1cd9bf69c1e8b05d37b1bc8ec25f68868d52de&Target=Affiliate_Offer&Method=findAll&limit=15"))
                        {
                            var httpResponseMessage = await httpClient.SendAsync(request);
                            var getResult = await httpResponseMessage.Content.ReadAsStringAsync();
                            var deserializedResponse = JsonSerializer.Deserialize<MainDataObject>(getResult);
                            List<Dictionary<string, Offer>> elements = deserializedResponse.Response.Data.Data.Values.ToList();


                            for (int i = 0; i < elements.Count; i++)
                            {
                                var element = elements[i];
                                <div class="col-md-4">
                                    <div class="box">
                                        <div class="img-box">
                                            <img src="@images[i]" alt="">
                                        </div>
                                        <div class="detail-box">
                                            <h5>@elements[i]["Offer"].Id</h5>
                                            <p>@elements[i]["Offer"].Name</p>

                                            <a href="javascript:void(0);" onclick="captureClickAndRedirect('@elements[i]["Offer"].Url', '@LoginModel.UserNameAndSurname')">Read More</a>
                                        </div>
                                    </div>
                                </div>
                            }
                        }
                    }
                }
            </div>
            <div class="btn-box">
                <a href="">
                    View All
                </a>
            </div>
        </div>
    </div>
</section>


<script>
    function captureClickAndRedirect(clickWebsite, clickName) {
        // AJAX call to send the captured data to the Razor Page handler method
        $.ajax({
            type: 'GET',
            url: '@Url.Page("index", "counterclicklink")',
            data: { clickWebsite: clickWebsite, clickName: clickName },
            success: function (response) {
                if (clickName != '') {
                    // Redirect to clickWebsite if clickName is not null
                    window.location.href = clickWebsite;
                } else {
                    // Redirect to the login page if clickName is null
                    window.location.href = '@Url.Page("/Login")';
                }
            },
            error: function (err) {
                console.log(err);
            }
        });
    }

</script>
<!-- end service section -->